<!DOCTYPE html>
<html>
<head>
  <title>Contacts</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="container">
  <h2>Mes contacts</h2>
  <div id="contacts"></div>

  <h2>Utilisateurs</h2>
  <div id="users"></div>

  <h2>Demandes reÃ§ues</h2>
  <div id="requests"></div>

  <button onclick="location.href='index.html'">â¬… Retour</button>
</div>

<script type="module">
  import { auth, db } from "./js/firebase.js";
  import {
    ref,
    onValue,
    get
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  import {
    sendRequest,
    acceptRequest,
    refuseRequest
  } from "./js/contacts.js";

  import {
    createPrivateConversation
  } from "./js/conversations.js";

  auth.onAuthStateChanged(user => {
    if (!user) location.href = "login.html";

    /* =========================
       ðŸ”¹ CONTACTS ACCEPTÃ‰S
    ==========================*/
    onValue(ref(db, `contacts/${user.uid}`), async snap => {
      contacts.innerHTML = "";
      if (!snap.exists()) return;

      for (let uid in snap.val()) {
        const userSnap = await get(ref(db, `users/${uid}`));
        if (!userSnap.exists()) continue;

        const u = userSnap.val();
        const div = document.createElement("div");
        div.className = "conversation";
        div.innerHTML = `
          <strong>${u.displayName}</strong>
          <small>${u.online ? "ðŸŸ¢ en ligne" : "âšª hors ligne"}</small>
        `;

        /* ðŸ‘‰ CLIQUER = OUVRIR / CRÃ‰ER DISCUSSION */
        div.onclick = async () => {
          const convId = await createPrivateConversation(uid);
          location.href = `chat.html?convId=${convId}`;
        };

        contacts.appendChild(div);
      }
    });

    /* =========================
       ðŸ”¹ UTILISATEURS (NON CONTACTS)
    ==========================*/
    onValue(ref(db, "users"), async snap => {
      users.innerHTML = "";
      if (!snap.exists()) return;

      const contactsSnap = await get(ref(db, `contacts/${user.uid}`));
      const contactsList = contactsSnap.exists() ? contactsSnap.val() : {};

      snap.forEach(child => {
        const uid = child.key;
        const u = child.val();

        if (uid === user.uid) return;
        if (contactsList[uid]) return;

        const div = document.createElement("div");
        div.className = "conversation";
        div.innerHTML = `
          <strong>${u.displayName}</strong>
          <button>Ajouter</button>
        `;

        div.querySelector("button").onclick = () => {
          sendRequest(uid);
          alert("Demande envoyÃ©e");
        };

        users.appendChild(div);
      });
    });

    /* =========================
       ðŸ”¹ DEMANDES REÃ‡UES
    ==========================*/
    onValue(ref(db, `contactRequests/${user.uid}`), async snap => {
      requests.innerHTML = "";
      if (!snap.exists()) return;

      for (let uid in snap.val()) {
        const userSnap = await get(ref(db, `users/${uid}`));
        const u = userSnap.val();

        const div = document.createElement("div");
        div.className = "conversation";
        div.innerHTML = `
          <strong>${u.displayName}</strong>
          <button>âœ”</button>
          <button>âœ–</button>
        `;

        div.children[1].onclick = () => acceptRequest(uid);
        div.children[2].onclick = () => refuseRequest(uid);

        requests.appendChild(div);
      }
    });
  });
</script>

</body>
</html>
