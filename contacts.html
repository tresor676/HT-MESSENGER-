<!DOCTYPE html>
<html>
<head>
  <title>Contacts</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="container">
  <h2>Mes contacts</h2>
  <button id="toggle">Ajouter des contacts</button>
  <div id="contacts"></div>
  <div id="users" style="display:none;"></div>

  <h2>Demandes reÃ§ues</h2>
  <div id="requests"></div>

  <button onclick="location.href='index.html'">â¬… Retour</button>
</div>

<script type="module">
  import { auth, db } from "./js/firebase.js";
  import { ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { sendRequest, acceptRequest, refuseRequest } from "./js/contacts.js";
  import { createPrivateConversation } from "./js/conversations.js";

  auth.onAuthStateChanged(user => {
    if (!user) location.href = "login.html";

    const toggleBtn = document.getElementById("toggle");
    const contactsDiv = document.getElementById("contacts");
    const usersDiv = document.getElementById("users");

    toggleBtn.onclick = () => {
      if(usersDiv.style.display === "none") {
        usersDiv.style.display = "block";
        contactsDiv.style.display = "none";
        toggleBtn.innerText = "Mes contacts";
      } else {
        usersDiv.style.display = "none";
        contactsDiv.style.display = "block";
        toggleBtn.innerText = "Ajouter des contacts";
      }
    }

    // ðŸ”¹ Mes contacts
    onValue(ref(db, `contacts/${user.uid}`), async snap => {
      contactsDiv.innerHTML = "";
      if (!snap.exists()) return;

      for (let uid in snap.val()) {
        const uSnap = await get(ref(db, `users/${uid}`));
        if (!uSnap.exists()) continue;

        const u = uSnap.val();
        const div = document.createElement("div");
        div.className = "conversation";
        div.innerHTML = `
          <strong>${u.displayName || uid}</strong>
          <small>${u.online ? "ðŸŸ¢ en ligne" : "âšª hors ligne"}</small>
        `;

        div.onclick = async () => {
          const convId = await createPrivateConversation(uid);
          location.href = `chat.html?convId=${convId}`;
        };

        contactsDiv.appendChild(div);
      }
    });

    // ðŸ”¹ Ajouter utilisateurs
    onValue(ref(db, "users"), async snap => {
      usersDiv.innerHTML = "";
      if (!snap.exists()) return;

      const contactsSnap = await get(ref(db, `contacts/${user.uid}`));
      const contactsList = contactsSnap.exists() ? contactsSnap.val() : {};

      snap.forEach(child => {
        const uid = child.key;
        const u = child.val();
        if (uid === user.uid) return;
        if (contactsList[uid]) return;

        const div = document.createElement("div");
        div.className = "conversation";
        div.innerHTML = `
          <strong>${u.displayName || uid}</strong>
          <button>Ajouter</button>
        `;

        div.querySelector("button").onclick = () => {
          sendRequest(uid);
          alert("Demande envoyÃ©e");
        };

        usersDiv.appendChild(div);
      });
    });

    // ðŸ”¹ Demandes reÃ§ues
    onValue(ref(db, `contactRequests/${user.uid}`), async snap => {
      const requestsDiv = document.getElementById("requests");
      requestsDiv.innerHTML = "";
      if (!snap.exists()) return;

      for (let uid in snap.val()) {
        const uSnap = await get(ref(db, `users/${uid}`));
        const u = uSnap.val();

        const div = document.createElement("div");
        div.className = "conversation";
        div.innerHTML = `
          <strong>${u.displayName || uid}</strong>
          <button>âœ”</button>
          <button>âœ–</button>
        `;

        div.children[1].onclick = () => acceptRequest(uid);
        div.children[2].onclick = () => refuseRequest(uid);

        requestsDiv.appendChild(div);
      }
    });
  });
</script>

</body>
</html>
