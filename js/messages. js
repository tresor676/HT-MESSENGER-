import { auth, db } from "./firebase.js";
import { ref, push, set, serverTimestamp, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

/* ➕ ENVOYER MESSAGE */
export async function sendMessage(convId, content) {
  const me = auth.currentUser.uid;
  const convRef = ref(db, `conversations/${convId}/participants`);

  // Récupérer tous les participants
  let participants = {};
  await onValue(convRef, snap => {
    participants = snap.val();
  }, { onlyOnce: true });

  const messageRef = push(ref(db, `messages/${convId}`));
  const messageId = messageRef.key;

  // Initialiser status pour chaque participant
  const status = {};
  for (let uid in participants) {
    status[uid] = uid === me ? "sent" : "received"; // moi = sent, autres = received
  }

  const messageData = {
    author: me,
    content,
    timestamp: serverTimestamp(),
    status
  };

  await set(messageRef, messageData);

  // Mise à jour conversation
  await set(ref(db, `conversations/${convId}/lastMessage`), content);
  await set(ref(db, `conversations/${convId}/updatedAt`), serverTimestamp());

  return messageId;
}

/* ✅ MARQUER UN MESSAGE COMME LU */
export async function markAsRead(convId) {
  const me = auth.currentUser.uid;
  const messagesRef = ref(db, `messages/${convId}`);

  onValue(messagesRef, snap => {
    if (!snap.exists()) return;

    snap.forEach(msgSnap => {
      const msg = msgSnap.val();
      if (msg.status[me] && msg.status[me] !== "read") {
        const updateStatus = {};
        updateStatus[`status/${me}`] = "read";
        update(ref(db, `messages/${convId}/${msgSnap.key}`), updateStatus);
      }
    });
  });
}
