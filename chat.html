<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="container">
  <div id="messages"></div>

  <div class="chat-input">
    <input id="text" placeholder="Message">
    <button id="send">Envoyer</button>
  </div>

  <button onclick="history.back()">â¬… Retour</button>
</div>

<script type="module">
import { auth, db } from "./js/firebase.js";
import { ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { updateLastMessage } from "./js/conversations.js";

const convId = new URLSearchParams(location.search).get("convId");
const messagesDiv = document.getElementById("messages");

onChildAdded(ref(db, `messages/${convId}`), snap => {
  const msg = snap.val();
  const div = document.createElement("div");
  div.className = msg.author === auth.currentUser.uid ? "bubble me" : "bubble";
  div.textContent = msg.text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

send.onclick = async () => {
  if (!text.value.trim()) return;

  const msg = {
    author: auth.currentUser.uid,
    text: text.value,
    createdAt: Date.now()
  };

  await push(ref(db, `messages/${convId}`), msg);
  await updateLastMessage(convId, text.value);
  text.value = "";
};
</script>

</body>
</html>
