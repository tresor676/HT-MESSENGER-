<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>HT Messenger â€” Chat</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="container">

  <!-- HEADER CHAT -->
  <div id="chat-header">
    <button id="back">â¬…</button>
    <div class="chat-title">
      <strong id="chat-name">Conversation</strong>
      <small id="chat-status">...</small>
    </div>
  </div>

  <!-- ZONE MESSAGES -->
  <div id="messages"></div>

  <!-- INPUT -->
  <div class="chat-input">
    <input id="text" placeholder="Ã‰crire un messageâ€¦">
    <button id="send">âž¤</button>
  </div>

</div>

<script type="module">
import { auth, db } from "./js/firebase.js";
import {
  ref,
  get,
  push,
  onChildAdded,
  update,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

import { updateLastMessage } from "./js/conversations.js";

const convId = new URLSearchParams(location.search).get("convId");
const messagesDiv = document.getElementById("messages");
const chatName = document.getElementById("chat-name");
const chatStatus = document.getElementById("chat-status");

/* ðŸ”™ retour */
back.onclick = () => history.back();

/* ðŸ” auth */
auth.onAuthStateChanged(async user => {
  if (!user) return location.href = "login.html";

  /* ðŸ”¹ charger conversation */
  const convSnap = await get(ref(db, `conversations/${convId}`));
  if (!convSnap.exists()) return alert("Conversation introuvable");

  const conv = convSnap.val();

  /* ðŸ”¹ conversation privÃ©e */
  if (conv.type === "private") {
    const otherUid = Object.keys(conv.participants)
      .find(uid => uid !== user.uid);

    const userSnap = await get(ref(db, `users/${otherUid}`));
    if (userSnap.exists()) {
      const u = userSnap.val();
      chatName.textContent = u.displayName;
      chatStatus.textContent = u.online ? "en ligne" : "hors ligne";
    }
  }

  /* ðŸ”¹ Ã©couter messages */
  onChildAdded(ref(db, `messages/${convId}`), snap => {
    const msg = snap.val();
    const div = document.createElement("div");

    div.className =
      msg.author === user.uid
        ? "bubble me"
        : "bubble";

    div.textContent = msg.text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
});

/* âœ‰ï¸ envoyer message */
send.onclick = async () => {
  const text = document.getElementById("text").value.trim();
  if (!text) return;

  const msg = {
    author: auth.currentUser.uid,
    text,
    createdAt: serverTimestamp()
  };

  await push(ref(db, `messages/${convId}`), msg);
  await updateLastMessage(convId, text);

  document.getElementById("text").value = "";
};

/* âŒ¨ï¸ envoyer avec EntrÃ©e */
text.addEventListener("keydown", e => {
  if (e.key === "Enter") send.click();
});
</script>

</body>
</html>
